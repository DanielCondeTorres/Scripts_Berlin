# Input Training Data Generation Pipeline
-----------------------------------------

### How To

To prepare simulation data for eventual use in training a transferable CG forcefield, these data must first be mapped to the CG resolution and then processed to incorporate prior energy terms. This is done: first, in `gen_input_data.py` the atomistic simualtions are loaded and mapped to the lower resolution, followed by the construction of the neighbourlists specific to the chosen prior energy model in the same step. Next, in the case that a prior model has not already been generated, this can be done by fitting the statistics of the saved CG data to a set of predefined energy functions. Finally, the outputs are fed to `produce_delta_forces.py` along with the prior model so that delta forces can be calculated. The result is a set of CG coordinates, embeddings, and delta forces which can be used to train a neural network as well as the neighbourlists associated with each molecule which can be fitted to produce new prior models, if needed. In the details below, input files are provided as an example.

#### 1) Loading and processing all-atom simulation data

Command:

`python ../scripts/gen_input_data.py process_raw_dataset --config trpcage.yaml`

`python ../scripts/gen_input_data.py build_neighborlists --config trpcage.yaml --config trpcage_priors.yaml`


This procedure will loop over all of the sample names in specified by the `names` option. For each instance, it will load the atomistic coordinates, forces, and structures and map these to a lower resolution specified in the input file (this allows for various resolutions and CG embeddings to be used). Then, using the PriorBuilders listed in `prior_builders`, the script will generate a neighbourlist for each molecule, so long as the prior builders are implemented in `prior_gen.py` and their specific neighbour list builders are implemented in `prior_nls.py`.

#### 2) Computing statistics and fitting priors

Command:

`python ../scripts/fit_priors.py compute_statistics --config trpcage_stats.yaml --config trpcage_priors.yaml`

`python ../scripts/fit_priors.py fit_priors --config trpcage_fit.yaml`

If a prior model has not already been created for a given set of samples, this can be generated by first computing features defined in the prior terms and then collecting statistics of these features from the input data, shown in the example. Finally, potential energy estimates are fitted to these statistics and saved as a new prior model.

#### 3) Producing delta forces

Command:

`python ../scripts/produce_delta_forces.py produce_delta_forces --config trpcage_delta_forces.yaml`

This procedure will load the prior model specified by `prior_fn` and then once again loop over all sample names provided. It will then calculate and remove the baseline forces using the coordinates, forces, embeddings, and neighbourlists created in the previous step. It will then save the delta forces which can then be used for training.

The following example script shows how delta forces can be computed on a computing cluster using GPU acceleration:

```
#!/bin/bash

#SBATCH --ntasks-per-node=1
#SBATCH --nodes=1
#SBATCH --mem=24G
#SBATCH --time=4-00:00:00
#SBATCH --gres=gpu:A5000:1
#SBATCH --partition=gpu
#SBATCH --output=trpcage_delta_forces_gpu.log
#SBATCH --job-name=trpcage_delta_forces_gpu

source /scratch/aguljas/miniconda3/bin/activate
conda activate mlcg_opeps-dataset

python ../scripts/produce_delta_forces.py produce_delta_forces --config trpcage_produce.yaml
```
Here, make sure to specify `cuda` for the `device` option in the config file. 
Note that depending on the machine being used and its available memory, it may be necessary to adjust the `batch_size`.

